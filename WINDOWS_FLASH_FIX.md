# Windows编译后软件闪退问题解决方案

## 问题描述
Windows编译后的软件在第一次可以正常打开，但在第二次打开时会出现闪退现象。经过分析，这个问题可能与以下因素有关：

1. 许可证验证失败
2. 原生模块加载失败
3. 配置文件损坏
4. 安全模块初始化异常

## 解决方案

### 1. 许可证验证增强
我们已经增强了许可证验证逻辑，增加了更多的错误处理和容错机制：

- 添加了输入参数验证
- 增加了Base64解码异常处理
- 添加了时间戳和日期有效性检查
- 增加了详细的错误日志记录

### 2. 原生模块加载容错
为了解决原生模块在打包后加载失败的问题，我们做了以下改进：

- 增加了多路径查找机制
- 添加了模拟对象，即使原生模块加载失败也不会导致应用崩溃
- 增加了详细的错误日志记录

### 3. 安全管理器容错
安全管理器现在具有更好的容错能力：

- 即使原生模块不可用，也会提供模拟实现
- 增加了详细的错误处理和日志记录
- 确保应用在安全模块初始化失败时仍能正常运行

### 4. 构建配置优化
优化了Electron Builder的配置，确保原生模块被正确打包：

- 更新了asarUnpack配置
- 改进了构建钩子，确保原生模块文件被正确复制
- 增加了错误处理，避免构建过程中断

## 验证步骤

1. 清除应用缓存：
   ```
   # Windows (PowerShell)
   Remove-Item -Recurse -Force "$env:APPDATA\web-navigation-container"
   
   # macOS
   rm -rf ~/Library/Application\ Support/web-navigation-container
   ```

2. 重新构建应用：
   ```bash
   npm run build:win
   ```

3. 安装并测试应用：
   - 第一次运行应用
   - 关闭应用
   - 第二次运行应用
   - 验证是否还存在闪退问题

## 常见问题排查

### 许可证问题
如果许可证验证失败，可以尝试：
1. 检查license.dat文件格式是否正确
2. 重新生成许可证
3. 检查机器指纹是否发生变化

### 原生模块问题
如果原生模块加载失败，可以尝试：
1. 重新编译原生模块：`cd native && npm install`
2. 检查构建输出目录结构
3. 验证disable_winkey.node文件是否存在

### 配置文件问题
如果配置文件损坏，可以尝试：
1. 删除用户数据目录中的配置文件
2. 让应用重新生成默认配置
3. 检查config.json文件格式是否正确

## 预防措施

1. 定期备份用户数据目录
2. 在发布新版本前进行充分测试
3. 增加更多的错误处理和日志记录
4. 提供用户友好的错误提示信息